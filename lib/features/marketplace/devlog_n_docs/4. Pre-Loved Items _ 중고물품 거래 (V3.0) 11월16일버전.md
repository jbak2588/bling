### **4\. Used Items / Barang Bekas / Pre-Loved Items / 중고물품 거래 (V3.0)**

#### **4.1 필요성 / Purpose**

(원본과 동일) 인도네시아의 지역 기반 중고 거래 수요 증가에 맞춰, 개인 간 신뢰 기반 거래와 AI 검수 기능을 결합한 ’안심 보장 중고 거래 시스템’을 구현하기 위한 핵심 메뉴입니다.

#### **4.2 주요 구성 / Key Components**

* **등록 방식 2종:**  
  1. **일반 등록:** 누구나 자유롭게 등록 (AI 검증 없음)  
  2. **AI 검수 등록:** 이미지 \+ 필수 정보 기반 AI 분석 → 검수 보고서 생성 (아래 '검수 시스템' 참조)  
* **상품 등록 항목:**  
  1. 카테고리 / 제목 / 설명 / 사진 (최소 1장) / 희망가 / 위치 / 연락방법 / 상태 (새것/중고) / 가격 협의 여부 / 태그  
* **검수 시스템 (V3 "단순 감정 엔진"):**  
  1. **1차 분석 (추가샷 제안):** 판매자가 상품 등록(또는 수정) 화면에서 사진과 필수 정보를 입력하고 'AI 검수 시작'을 누르면, 백엔드 `initialProductAnalysis`가 AI를 호출합니다. AI는 제공된 정보를 기반으로 "구매자 신뢰에 필요한" **추가 사진을 텍스트로 제안**합니다. (예: "배터리 성능 화면을 찍어주세요", "모서리 4곳을 근접 촬영해 주세요")  
  2. **2차 분석 (최종 보고서 생성):** 판매자가 AI의 제안에 따라 "추가샷"을 보강하여 '최종 보고서 생성'을 누르면, 백엔드 `generateFinalReport`가 **모든 이미지와 텍스트**를 AI에 전달합니다. AI는 Task 92에서 수정한 프롬프트에 따라 **V3 JSON 리포트**를 반환합니다.  
     * `itemSummary`: 예측 모델명, 카테고리 일치 여부  
     * `condition`: 상태 등급(A,B,C), 등급 사유, 세부 항목(배터리, 스크래치 등)  
     * `priceAssessment`: 적정 시세 범위 (Min/Max)  
     * `notesForBuyer`: 구매자 주의사항  
     * `verificationSummary`: AI 종합 요약  
     * `onSiteVerificationChecklist`: 구매자를 위한 **현장 검증 체크리스트** (예: "IMEI 확인")  
     * `trustVerdict`: AI의 최종 신뢰 등급 (`clear`, `suspicious`, `fraud`)  
  3. **검증 분기 ("블라인드 제출"):**  
     * **If `trustVerdict == 'clear'`:** AI가 상품을 '신뢰'합니다. 리포트가 `AiFinalReportScreen`에 표시되며, 판매자가 '최종 등록' 시 `status: 'selling'` 및 `isAiVerified: true`로 즉시 게시됩니다.  
     * **If `trustVerdict == 'suspicious' | 'fraud'`:** AI가 '사기 의심'(예: 조작된 날짜, 비현실적 모델명)을 감지합니다. 판매자에게는 **보고서가 표시되지 않고**, "관리자 검토를 위해 제출되었습니다"라는 중립적인 팝업만 뜬 뒤, 상품이 `status: 'pending'` 및 `isAiVerified: false`로 저장됩니다.  
* **구매 요청 구조 (V3 "AI 안심 인수"):**  
  1. 구매자는 `isAiVerified: true`로 승인된 상품 상세페이지에서 **'AI 안심 예약'** 버튼을 누르고 10% 예약금을 결제합니다. (PG 연동 필요)  
  2. 상품의 `status`가 `reserved`로 변경되고, `buyerId`가 기록됩니다.  
  3. 구매자는 판매자와 약속된 장소에서 `AiTakeoverScreen` (현장 인수 화면)을 엽니다.  
  4. 화면에는 AI가 2차 분석 시 생성했던 **`onSiteVerificationChecklist`** (예: "IMEI 확인", "카메라 테스트")가 표시됩니다.  
  5. 구매자는 이 체크리스트에 따라 현장 상품의 사진(1\~5장)을 촬영하고 **'AI 동일성 검증'** 버튼을 누릅니다.  
  6. 백엔드 `verifyProductOnSite`가 호출되어, (A)판매자의 원본 사진과 (B)구매자의 현장 사진을 **A/B 비교**합니다.  
  7. AI가 `{ match: true/false/null, reason: "..." }` 결과를 반환합니다.  
  8. **If `match: true`:** "일치" 팝업 표시 → 구매자가 '최종 인수' 버튼을 눌러 거래를 확정합니다. (나머지 90% 결제 로직 필요)  
  9. **If `match: false`:** "불일치" 팝업 표시 → 구매자가 '거래 취소' 버튼을 눌러 예약금을 환불받습니다.  
  10. **If `match: null`:** (AI 실패 시) "검증 실패" 팝업 표시 → 구매자가 **"재시도"** 버튼을 눌러 검증을 다시 시도합니다.

#### **4.3 핵심 시스템 설명 / System Logic**

* **에스크로 구조:**  
  * (원본과 동일) 예약금(10%)은 Firebase Function \+ 결제 API로 잠금 처리됩니다. (PG 연동은 V3.0의 향후 과제)  
  * 거래 완료 시 전체 금액이 정산됩니다.  
* **거래 보증 절차 (V3):**  
  * AI 인수는 더 이상 판매자의 실물 비교가 아닌, **구매자**가 주도합니다.  
  * 구매자는 AI가 생성한 `onSiteVerificationChecklist`를 보고 현장 사진을 촬영합니다.  
  * AI는 **'원본 사진(A)'과 '현장 사진(B)'을 비교**하여, '현장 사진(B)'에만 존재하는 새로운 하자(스크래치, 균열 등)나 불일치 여부를 검사하여 `match` 결과를 반환합니다.  
  * 반복적인 불일치(`match: false`) 발생 시, 판매자 신뢰도에 영향을 줍니다. (향후 과제)

#### **5\. 향후 과제 (V3.0 로드맵)**

* **유료 결제(PG) 연동 (구현 미비):**  
  * (원본과 동일) 'AI 안심 예약'(10% 예약금), '유료 끌어올리기', 'AI 보고서 유료 재발급' 등 신뢰 기반의 수익 모델을 완성합니다.  
  * (원본과 동일) 현재 `reserveProduct` 및 `ai_verification_service.dart` 등에는 결제 로직을 위한 `// TODO` 주석만 명시되어 있습니다.  
* **판매/구매 상호 신뢰도 도입 (개편안 3 / 구현 미비):**  
  * (원본과 동일) 거래 완료 후, 판매자와 구매자가 서로를 평가(후기, 평점, 노쇼 신고 등)하는 상호 신뢰도 시스템을 도입합니다.  
  * (원본과 동일) 현재는 범용 `trustScore`만 존재합니다.  
* **부정 사용자 페널티 시스템 (신규 / 구현 미비):**  
  * **목표:** AI 오탐(False Positive)은 보호하되, 실제 사기 사용자(Fraud User)는 제재합니다.  
  * **구현:** 관리자가 `admin_product_detail_screen`에서 '거절' 버튼을 누를 때, 판매자의 `user_model`에 `aiRejectionCount` 필드를 1 증가시킵니다. (Task 103/104에서 설계)  
  * **정책:** `product_registration_screen` 등에서 `userModel.aiRejectionCount`가 일정 횟수(예: 3회) 이상이면, 신규 상품 등록 및 AI 검수 요청을 차단하는 로직을 구현합니다. (TODO)

